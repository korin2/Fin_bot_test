import logging
from telegram import Update
from telegram.ext import ContextTypes
from config import logger
from utils import log_user_action, create_main_reply_keyboard
# –û–±–Ω–æ–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç—ã
from api_currency import get_currency_rates_with_history, format_currency_rates_message
from api_keyrate import get_key_rate, format_key_rate_message
from api_crypto import get_crypto_rates, get_crypto_rates_fallback, format_crypto_rates_message
from api_weather import get_weather_moscow, format_weather_message
from api_ruonia import get_ruonia_rate, format_ruonia_message


async def show_currency_rates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç"""
    try:
        log_user_action(update.effective_user.id, "view_currency_rates")

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        rates_today, date_today, rates_yesterday, changes_yesterday, rates_tomorrow, changes_tomorrow = get_currency_rates_with_history()

        if not rates_today:
            await update.message.reply_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.",
                reply_markup=create_main_reply_keyboard()
            )
            return

        message = format_currency_rates_message(
            rates_today, date_today, rates_yesterday, changes_yesterday,
            rates_tomorrow, changes_tomorrow
        )
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=create_main_reply_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.", reply_markup=create_main_reply_keyboard())

# –≤–∏–¥–∏–º–æ –ª–∏—à–Ω–µ–µ–µ —É–∂–µ
async def show_key_rate(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é —Å—Ç–∞–≤–∫—É"""
    try:
        log_user_action(update.effective_user.id, "view_key_rate")

        key_rate_data = get_key_rate()

        if not key_rate_data:
            await update.message.reply_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–ª—é—á–µ–≤—É—é —Å—Ç–∞–≤–∫—É.",
                reply_markup=create_main_reply_keyboard()
            )
            return

        message = format_key_rate_message(key_rate_data)
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=create_main_reply_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.", reply_markup=create_main_reply_keyboard())
# –≤–∏–¥–∏–º–æ –ª–∏—à–Ω–µ–µ–µ —É–∂–µ

async def show_cbr_rates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é —Å—Ç–∞–≤–∫—É –∏ RUONIA"""
    try:
        log_user_action(update.effective_user.id, "view_cbr_rates")

        # –ü–æ–ª—É—á–∞–µ–º –æ–±–µ —Å—Ç–∞–≤–∫–∏
        key_rate_data = get_key_rate()
        ruonia_data = get_ruonia_rate()

        if not key_rate_data and not ruonia_data:
            await update.message.reply_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–∞–≤–∫–∞–º –¶–ë –†–§.",
                reply_markup=create_main_reply_keyboard()
            )
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = "üèõÔ∏è <b>–°–¢–ê–í–ö–ò –¶–ë –†–§</b>\n\n"

        if key_rate_data:
            message += (
                f"üíé <b>–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞:</b> {key_rate_data['rate']:.2f}%\n"
                f"üìÖ <b>–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:</b> {key_rate_data.get('date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n\n"
            )

        if ruonia_data:
            message += (
                f"üìä <b>–°—Ç–∞–≤–∫–∞ RUONIA:</b> {ruonia_data['rate']:.2f}%\n"
                f"üìÖ <b>–î–∞—Ç–∞:</b> {ruonia_data.get('date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n\n"
            )

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏—è
        message += (
            "üí° <b>–ü–æ—è—Å–Ω–µ–Ω–∏—è:</b>\n"
            "‚Ä¢ <b>–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞</b> - –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –¶–ë –†–§\n"
            "‚Ä¢ <b>RUONIA</b> - —Å—Ä–µ–¥–Ω—è—è —Å—Ç–∞–≤–∫–∞ –ø–æ –æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–º —Ä—É–±–ª–µ–≤—ã–º –¥–µ–ø–æ–∑–∏—Ç–∞–º\n\n"
        )

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
        sources = []
        if key_rate_data and key_rate_data.get('source') == 'demo':
            sources.append("–∫–ª—é—á–µ–≤–æ–π —Å—Ç–∞–≤–∫–∏")
        if ruonia_data and ruonia_data.get('source') == 'demo':
            sources.append("RUONIA")

        if sources:
            message += f"‚ö†Ô∏è <i>–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è: {', '.join(sources)}</i>"
        else:
            message += "‚úÖ <i>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ –¶–ë –†–§</i>"

        await update.message.reply_text(message, parse_mode='HTML', reply_markup=create_main_reply_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å—Ç–∞–≤–æ–∫ –¶–ë –†–§: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.", reply_markup=create_main_reply_keyboard())





async def show_crypto_rates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç"""
    try:
        log_user_action(update.effective_user.id, "view_crypto_rates")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
        loading_message = "üîÑ <b>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç...</b>"
        await update.message.reply_text(loading_message, parse_mode='HTML')

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        crypto_rates = get_crypto_rates()

        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        if not crypto_rates:
            logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç CoinGecko, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback")
            crypto_rates = get_crypto_rates_fallback()

        if not crypto_rates:
            error_msg = "‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç.</b>"
            await update.message.reply_text(error_msg, parse_mode='HTML', reply_markup=create_main_reply_keyboard())
            return

        message_text = format_crypto_rates_message(crypto_rates)

        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
        if crypto_rates.get('source') == 'demo_fallback':
            message_text += "\n\n‚ö†Ô∏è <i>–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (CoinGecko API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)</i>"

        await update.message.reply_text(message_text, parse_mode='HTML', reply_markup=create_main_reply_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –∫—É—Ä—Å–æ–≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.", reply_markup=create_main_reply_keyboard())

async def show_weather(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –≤ –ú–æ—Å–∫–≤–µ"""
    try:
        log_user_action(update.effective_user.id, "view_weather")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
        loading_message = "üîÑ <b>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ...</b>"
        await update.message.reply_text(loading_message, parse_mode='HTML')

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ
        weather_data = get_weather_moscow()
        message = format_weather_message(weather_data)

        await update.message.reply_text(message, parse_mode='HTML', reply_markup=create_main_reply_keyboard())

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–æ–≥–æ–¥—ã: {e}")
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ.",
            reply_markup=create_main_reply_keyboard()
        )
