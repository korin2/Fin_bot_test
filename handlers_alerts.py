import logging
from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import ContextTypes
from config import logger, SUPPORTED_CURRENCIES
from utils import log_user_action, create_alerts_keyboard, create_currency_selection_keyboard, create_alert_direction_keyboard
from db import get_user_alerts, clear_user_alerts, add_alert
from services import get_currency_rates_with_tomorrow

async def show_alerts_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
    try:
        user_id = update.effective_user.id
        log_user_action(user_id, "view_alerts_menu")
        
        message = (
            "üîî <b>–£–ü–†–ê–í–õ–ï–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò</b>\n\n"
            "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –æ –∫—É—Ä—Å–∞—Ö –≤–∞–ª—é—Ç.\n\n"
            "üí° <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>\n"
            "‚Ä¢ –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—É—Ä—Å—ã –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç\n"
            "‚Ä¢ –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —É—Å–ª–æ–≤–∏—è –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n"
            "‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è\n\n"
            "üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
        )
        
        reply_markup = create_alerts_keyboard()
        logger.info(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=reply_markup)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.", reply_markup=create_main_reply_keyboard())

async def start_create_alert(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã"""
    try:
        user_id = update.effective_user.id
        log_user_action(user_id, "start_create_alert")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        context.user_data['creating_alert'] = True
        context.user_data['alert_stage'] = 'select_currency'
        
        message = (
            "üí± <b>–°–û–ó–î–ê–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</b>\n\n"
            "üìù <b>–®–∞–≥ 1 –∏–∑ 3:</b> –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É\n\n"
            "üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞:</b>"
        )
        
        reply_markup = create_currency_selection_keyboard()
        logger.info(f"–ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=reply_markup)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.", reply_markup=create_alerts_keyboard())

async def handle_currency_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    try:
        selected_currency = update.message.text
        
        if selected_currency not in SUPPORTED_CURRENCIES:
            await update.message.reply_text(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ:",
                reply_markup=create_currency_selection_keyboard()
            )
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
        context.user_data['alert_currency'] = selected_currency
        context.user_data['alert_stage'] = 'select_direction'
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        rates_today, _, _, _ = get_currency_rates_with_tomorrow()
        current_rate = "N/A"
        if rates_today and selected_currency in rates_today:
            current_rate = f"{rates_today[selected_currency]['value']:.2f}"
        
        message = (
            f"üí± <b>–°–û–ó–î–ê–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</b>\n\n"
            f"üìù <b>–®–∞–≥ 2 –∏–∑ 3:</b> –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ\n\n"
            f"üíπ <b>–í—ã–±—Ä–∞–Ω–Ω–∞—è –≤–∞–ª—é—Ç–∞:</b> {selected_currency}\n"
            f"üí∞ <b>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å:</b> {current_rate} —Ä—É–±.\n\n"
            f"üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>\n"
            f"‚Ä¢ <b>–í—ã—à–µ –ø–æ—Ä–æ–≥–∞</b> - —É–≤–µ–¥–æ–º–∏—Ç –∫–æ–≥–¥–∞ –∫—É—Ä—Å –ü–†–ï–í–´–°–ò–¢ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n"
            f"‚Ä¢ <b>–ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞</b> - —É–≤–µ–¥–æ–º–∏—Ç –∫–æ–≥–¥–∞ –∫—É—Ä—Å –°–¢–ê–ù–ï–¢ –ù–ò–ñ–ï —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è"
        )
        
        reply_markup = create_alert_direction_keyboard()
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=reply_markup)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞–ª—é—Ç—ã: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–∞–ª—é—Ç—ã.", reply_markup=create_alerts_keyboard())

async def handle_direction_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    try:
        direction_text = update.message.text
        
        if direction_text == "üìà –í—ã—à–µ –ø–æ—Ä–æ–≥–∞":
            direction = 'above'
            direction_display = '–≤—ã—à–µ'
        elif direction_text == "üìâ –ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞":
            direction = 'below'
            direction_display = '–Ω–∏–∂–µ'
        else:
            await update.message.reply_text(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞:",
                reply_markup=create_alert_direction_keyboard()
            )
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        context.user_data['alert_direction'] = direction
        context.user_data['alert_direction_display'] = direction_display
        context.user_data['alert_stage'] = 'enter_threshold'
        
        currency = context.user_data['alert_currency']
        
        message = (
            f"üí± <b>–°–û–ó–î–ê–ù–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</b>\n\n"
            f"üìù <b>–®–∞–≥ 3 –∏–∑ 3:</b> –£–∫–∞–∂–∏—Ç–µ –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n\n"
            f"üíπ <b>–í–∞–ª—é—Ç–∞:</b> {currency}\n"
            f"üìä <b>–£—Å–ª–æ–≤–∏–µ:</b> –∫—É—Ä—Å —Å—Ç–∞–Ω–µ—Ç <b>{direction_display}</b> —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è\n\n"
            f"üí∞ <b>–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä—É–±–ª—è—Ö:</b>\n\n"
            f"üí° <i>–ü—Ä–∏–º–µ—Ä: 85.50 –∏–ª–∏ 90</i>"
        )
        
        keyboard = [[KeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ —É—Å–ª–æ–≤–∏—è–º")]]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=reply_markup)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É—Å–ª–æ–≤–∏—è.", reply_markup=create_alerts_keyboard())

async def handle_threshold_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –ø–æ—Ä–æ–≥–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Å–æ–∑–¥–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"""
    try:
        threshold_text = update.message.text
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞–∑–∞–¥
        if threshold_text == "üîô –ù–∞–∑–∞–¥ –∫ —É—Å–ª–æ–≤–∏—è–º":
            context.user_data['alert_stage'] = 'select_direction'
            await handle_currency_selection(update, context)
            return
        
        # –ü–∞—Ä—Å–∏–º –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        try:
            threshold = float(threshold_text.replace(',', '.'))
            if threshold <= 0:
                raise ValueError("–ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        except ValueError:
            await update.message.reply_text(
                "‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞!</b>\n\n"
                "üí∞ <b>–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ä—É–±–ª—è—Ö:</b>\n"
                "üí° <i>–ü—Ä–∏–º–µ—Ä: 85.50 –∏–ª–∏ 90</i>",
                parse_mode='HTML'
            )
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ context
        currency = context.user_data.get('alert_currency')
        direction = context.user_data.get('alert_direction')
        direction_display = context.user_data.get('alert_direction_display')
        
        if not all([currency, direction]):
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.",
                reply_markup=create_alerts_keyboard()
            )
            return
        
        user_id = update.effective_user.id
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        await add_alert(user_id, currency, 'RUB', threshold, direction)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        rates_today, _, _, _ = get_currency_rates_with_tomorrow()
        current_rate = "N/A"
        if rates_today and currency in rates_today:
            current_rate = f"{rates_today[currency]['value']:.2f}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
        success_message = (
            f"‚úÖ <b>–£–í–ï–î–û–ú–õ–ï–ù–ò–ï –°–û–ó–î–ê–ù–û!</b>\n\n"
            f"üí± <b>–ü–∞—Ä–∞:</b> {currency}/RUB\n"
            f"üéØ <b>–ü–æ—Ä–æ–≥:</b> {threshold} —Ä—É–±.\n"
            f"üìä <b>–£—Å–ª–æ–≤–∏–µ:</b> –∫—É—Ä—Å <b>{direction_display}</b> {threshold} —Ä—É–±.\n"
            f"üíπ <b>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å:</b> {current_rate} —Ä—É–±.\n\n"
            f"‚è∞ <i>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</i>\n"
            f"üîî <i>–ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</i>\n"
            f"üìã <i>–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ '–ú–æ–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'</i>"
        )
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        context.user_data.pop('creating_alert', None)
        context.user_data.pop('alert_stage', None)
        context.user_data.pop('alert_currency', None)
        context.user_data.pop('alert_direction', None)
        context.user_data.pop('alert_direction_display', None)
        
        await update.message.reply_text(
            success_message,
            parse_mode='HTML',
            reply_markup=create_alerts_keyboard()
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        log_user_action(user_id, "alert_created", {
            "currency": currency,
            "threshold": threshold,
            "direction": direction
        })
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
        await update.message.reply_text(
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.",
            reply_markup=create_alerts_keyboard()
        )

async def myalerts_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        user_id = update.effective_user.id
        log_user_action(user_id, "view_my_alerts")
        
        alerts = await get_user_alerts(user_id)
        
        if not alerts:
            message = (
                "üì≠ <b>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</b>\n\n"
                "üí° –ù–∞–∂–º–∏—Ç–µ <b>üí± –°–æ–∑–¥–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</b> —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!"
            )
            
            await update.message.reply_text(message, parse_mode='HTML', reply_markup=create_alerts_keyboard())
            return
        
        message = "üîî <b>–í–ê–®–ò –ê–ö–¢–ò–í–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</b>\n\n"
        
        for i, alert in enumerate(alerts, 1):
            from_curr = alert['from_currency']
            to_curr = alert['to_currency']
            threshold = alert['threshold']
            direction = alert['direction']
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            rates_today, _, _, _ = get_currency_rates_with_tomorrow()
            current_rate = "N/A"
            if rates_today and from_curr in rates_today:
                current_rate = f"{rates_today[from_curr]['value']:.2f}"
            
            direction_display = '–≤—ã—à–µ' if direction == 'above' else '–Ω–∏–∂–µ'
            status_icon = "üü¢" if alert.get('is_active', True) else "üî¥"
            
            message += (
                f"{status_icon} <b>{i}. {from_curr} ‚Üí {to_curr}</b>\n"
                f"   üéØ –ü–æ—Ä–æ–≥: <b>{threshold} —Ä—É–±.</b>\n"
                f"   üìä –£—Å–ª–æ–≤–∏–µ: –∫—É—Ä—Å <b>{direction_display}</b> {threshold} —Ä—É–±.\n"
                f"   üí± –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: <b>{current_rate} —Ä—É–±.</b>\n\n"
            )
        
        message += (
            "‚è∞ <i>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</i>\n"
            "üí° <i>–ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è</i>"
        )
        
        reply_markup = create_alerts_keyboard()
        await update.message.reply_text(message, parse_mode='HTML', reply_markup=reply_markup)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /myalerts: {e}")
        error_message = "‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</b>"
        await update.message.reply_text(error_message, parse_mode='HTML', reply_markup=create_alerts_keyboard())

async def alert_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫—É—Ä—Å–µ –≤–∞–ª—é—Ç—ã —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É"""
    try:
        log_user_action(update.effective_user.id, "create_alert", {"args": context.args})
        
        args = context.args
        
        if len(args) != 4:
            await update.message.reply_text(
                "üìù <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b> /alert &lt;–∏–∑&gt; &lt;–≤&gt; &lt;–ø–æ—Ä–æ–≥&gt; &lt;above|below&gt;\n\n"
                "üí° <b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
                "‚Ä¢ <code>/alert USD RUB 80 above</code> - —É–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–≥–¥–∞ USD –≤—ã—à–µ 80 —Ä—É–±.\n"
                "‚Ä¢ <code>/alert EUR RUB 90 below</code> - —É–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–≥–¥–∞ EUR –Ω–∏–∂–µ 90 —Ä—É–±.\n"
                "‚Ä¢ <code>/alert AED RUB 22 above</code> - —É–≤–µ–¥–æ–º–∏—Ç—å –∫–æ–≥–¥–∞ AED –≤—ã—à–µ 22 —Ä—É–±.",
                parse_mode='HTML',
                reply_markup=create_main_reply_keyboard()
            )
            return
        
        from_curr, to_curr = args[0].upper(), args[1].upper()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã
        supported_currencies = ['USD', 'EUR', 'GBP', 'JPY', 'CNY', 'CHF', 'CAD', 'AUD', 'TRY', 'KZT', 'AED']
        if from_curr not in supported_currencies:
            await update.message.reply_text(
                f"‚ùå –í–∞–ª—é—Ç–∞ <b>{from_curr}</b> –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.\n\n"
                f"üí± <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–ª—é—Ç—ã:</b> {', '.join(supported_currencies)}",
                parse_mode='HTML',
                reply_markup=create_main_reply_keyboard()
            )
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞ - RUB
        if to_curr != 'RUB':
            await update.message.reply_text(
                "‚ùå –í –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–∞—Ä —Å RUB.\n"
                "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <code>/alert USD RUB 80 above</code>",
                parse_mode='HTML',
                reply_markup=create_main_reply_keyboard()
            )
            return
        
        try:
            threshold = float(args[2])
            if threshold <= 0:
                raise ValueError("–ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º")
        except ValueError:
            await update.message.reply_text(
                "‚ùå –ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.",
                reply_markup=create_main_reply_keyboard()
            )
            return
        
        direction = args[3].lower()
        if direction not in ['above', 'below']:
            await update.message.reply_text(
                "‚ùå –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'above' –∏–ª–∏ 'below'.",
                reply_markup=create_main_reply_keyboard()
            )
            return
        
        user_id = update.effective_message.from_user.id
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await add_alert(user_id, from_curr, to_curr, threshold, direction)
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        rates_today, _, _, _ = get_currency_rates_with_tomorrow()
        current_rate = "N/A"
        if rates_today and from_curr in rates_today:
            current_rate = f"{rates_today[from_curr]['value']:.2f}"
        
        success_message = (
            f"‚úÖ <b>–£–í–ï–î–û–ú–õ–ï–ù–ò–ï –£–°–¢–ê–ù–û–í–õ–ï–ù–û!</b>\n\n"
            f"üí± <b>–ü–∞—Ä–∞:</b> {from_curr}/{to_curr}\n"
            f"üéØ <b>–ü–æ—Ä–æ–≥:</b> {threshold} —Ä—É–±.\n"
            f"üìä <b>–£—Å–ª–æ–≤–∏–µ:</b> –∫—É—Ä—Å <b>{'–≤—ã—à–µ' if direction == 'above' else '–Ω–∏–∂–µ'}</b> {threshold} —Ä—É–±.\n"
            f"üíπ <b>–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å:</b> {current_rate} —Ä—É–±.\n\n"
            f"üí° –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç\n"
            f"üîî –ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
        )
        
        await update.message.reply_text(
            success_message,
            parse_mode='HTML',
            reply_markup=create_main_reply_keyboard()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /alert: {e}")
        await update.message.reply_text(
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:\n<code>{str(e)}</code>",
            parse_mode='HTML',
            reply_markup=create_main_reply_keyboard()
        )

async def handle_alerts_back_navigation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    try:
        back_text = update.message.text
        
        if back_text == "üîô –ù–∞–∑–∞–¥ –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º":
            await show_alerts_menu(update, context)
        elif back_text == "üîô –ù–∞–∑–∞–¥ –∫ –≤–∞–ª—é—Ç–∞–º":
            context.user_data['alert_stage'] = 'select_currency'
            await start_create_alert(update, context)
        elif back_text == "üîô –ù–∞–∑–∞–¥ –∫ —É—Å–ª–æ–≤–∏—è–º":
            currency = context.user_data.get('alert_currency')
            if currency:
                context.user_data['alert_stage'] = 'select_direction'
                await handle_currency_selection(update, context)
            else:
                await start_create_alert(update, context)
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.", reply_markup=create_alerts_keyboard())
